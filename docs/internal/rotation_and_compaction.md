 # ローテーションとコンパクション

本ドキュメントでは、LOG-0.6でのローテーション処理とコンパクション処理
について記述する。

## ローテーション

LOG-0.5以前のローテーションには以下の問題がある。

1. ローテーション終了後も、ローテーション済みのファイルへの書き込みが行われる可能性があり、一部データが欠損したローテーション済みファイルを使用した処理が行われることがある。
2. 複数のローテーションリクエストを同時に正しく処理することはできない。
3. ローテーション中にエポックの切り替えが発生し、特定のエポックのデータの一部がローテーション済みファイル、残りがローテーション後のアクティブなPWALファイルに書き込まれる可能性がある。
4. 3.と同じ原因で、ローテーション済みのPWALファイルと、ローテーション済みのエポックファイルのデュラブルエポックIDが一致しない可能性がある。
5. ローテーション完了後、エポックの切り替えの開始前に開始したログチャネルのセッションのデータはローテーション済みのPWALファイルに書かれるべきだが、書かれない。
6. ローテーション済みのファイルのリストの作成などをローテーション後に行っているため、連続してローテーションが行われたときに、不正なリストが作成されてしまう。

これらの問題はローテーションの実行タイミングの問題である。LOG-0.6では、これらの問題を解決するために以下の制御を
追加する。

1. ローテーションの要求に対して即座に処理を開始せずにリクエストをキューに入れ、リクエストの完了を待つ。
2. エポックの切り替え処理に先立ち、ローテーション要求のキューを確認しキューにリクエストがある場合は、ローテーション処理を行う。具体的にはPWALとエポックファイルのリネームを行う。1回のエポック切り替えで、高々1回しかリクエストを処理しない。
3. PWALとエポックファイルのリネームが終了したらエポックの切り替え処理を継続する。
4. 2.の処理時にアクティブなセションを持つログチャネルが存在する場合、アクティブなセッションがすべて終了するのを待ち、ローテーション要求に応答する。この処理は、3の処理と非同期に行う。
5. ローテーション後のファイルのリストをローテーションの要求もとに戻す。
   * コンパクション処理のために、このローテーション処理でローテーションされたPWALファイルだけでなく、全てのローテーション済みファイルのリストが必要である。
   * その他の必要な情報は、現行のコードに準じる。


## コンパクション

* 同時に複数のコンパクション処理を行わないように制御する。
* コンパクションが要求されたら、まずローテーションを行う。
* ローテーションが終了したら、コンパクションの対象となるPWALファイルを特定する。
  * 未ローテートのPWALファイルはコンパクションに対象ではない。
  * ローテーション済みのPWALファイルのリストから、コンパクションの対象となるファイルを選択する。
  * コンパクション処理中にローテーションが行われて、ローテーション済みのPWALファイルが増えても、これらのファイルはコンパクションの対象とはしない。このため、ローテーション済みファイルのリストは、ファイルシステムを調べて作成するのではなく、ローテーション処理の結果から取得する必要がある。
  * コンパクションカタログを調べ、コンパクション済みと記録されているPWALファイルはコンパクションの対象から外す。
  * 残ったローテーション済みのPWALファイルについては、当該ファイルに記録されている最初のセッションのエポックIDを取り出し、コンパクションカタログのエポックIDより大きなエポックIDであったPWALファイルのみをコンパクションの対象とする。
  * LOG-0.5のオフラインコンパクションツールと同じロジックでコンパクションを行う。
    * コンパクションの対象となるファイルは、コンパクションの対象となったPWALファイルと、前回のコンパクション処理で作成したコンパクション済みファイルである。
    * コンパクション済みファイルのファイル名は、LOG-0.6の使用に合わせて決定する。
    * オフラインコンパクションツールと異なり、コンパクションの対象となったPWALファイルは削除しない
  * コンパクションカタログについては、[コンパクション済みファイルとコンパクションカタログ](file_format.md)にしたがって処理する。


## 起動時のスナップショット作成

* LOG-0.5とLOG-0.6で、スナップショット作成対象となるファイルが異なる。
  * LOG-0.5では全PWALファイルが対象
  * LOG-0.6では未ローテートのPWALファイルとコンパクション済みファイル、および未コンパクションのローテート済みPWALファイルが対象となる。
  * 未ローテートのPWALファイルはコンパクションカタログを用いて、コンパクション対象のローテート済みPWALファイル作成時と同様の方法で選択する。ただし、ローテート済みファイルのリストはローテート処理の結果ではなく、ファイルシステムから取得する。


## コンパクションのトリガ

  とりあえず簡単に動くものをつくる

  * コンパクション用のスレッドを1つよういする。datastoreの初期化時にスレッドを生成し、シャットダウン時にスレッドを停止する。
  * このスレッドは、ログディレクトリの"start_compaction"というファイル名のファイルの有無を確認する。
  * ファイルの存在を確認したら、ファイルを削除し、コンパクション処理を実行し、実行結果を"comaction_result"というファイルに出力する。
  * このしくみにより、自動的にコンパクションが同時に実行されなくなる。
  * "start_compaction"ファイルを作成し、"comaction_result"の内容を表示するコマンドを作成する

## コンパクションスレッド

* 初期化終了時にコンパクションスレッドを作成する
* datasotreのシャットダウン時と、datastoreのデストラクタ呼び出し時ににスレッドを停止する。
* コンパクションスレッドは、ログディレクトリに`ctrl`ディレクトリが存在しない場合、作成する。
* `ctrl`ディレクトリに`start_compaction`というファイル名のファイルが作成されたら、コンパクションを開始し、コンパクションが終了するとstawrt_compaction処理を終了する。


