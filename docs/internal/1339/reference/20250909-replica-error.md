# 技術検討

## テーマ

* [レプリケーションエラー時の挙動と対応](#レプリケーションエラー時の挙動と対応)
  * 番さん
  * 埋金さん
* [レプリケーション系コマンド案](#レプリケーション系コマンド案)
  * 埋金さん

## レプリケーションエラー時の挙動と対応

レプリケーションエラーとは、トランザクションのコミット時に、コミットの伝搬を必要なレプリカに対して行えなかった場合に発生するエラー。

### レプリケーションエラー: やりたいこと

レプリケーションエラー発生時に、以下の任意から設定で選べるようにする。

* (A) レプリカを切り離してエラーログを出力し、トランザクションをローカルと利用可能なレプリカのみにコミットする
* (B) エラーを利用者に通知し、トランザクションをロールバック後、レプリカが正常に戻るまでトランザクションを閉塞する

### レプリケーションエラー: 共通の修正事項

* persistent callback の仕組みに以下の拡張を加える
  * イベントのコミットの種類 (`STORED`: local commit, `PROPAGATED`: replica commit - 規定数のレプリカに書き込めた) を追加
  * ステータス情報 (success, failure) を追加
  * エラー情報 (エラーコード、エラーメッセージ) を追加
* jogasaki に以下の拡張を加える
  * persistent callback のイベントに対して、必要に応じてエラーをユーザーに通知する仕組みを追加

### (A) レプリカの切り離し

エラー発生時はおおよそ以下のような流れになる:

* (1) jogasaki がトランザクション T1 のコミットを Shirakami に要求
* (2) Shirakami がトランザクション T1 のコミットを Limestone に要求
* (3) Limestone がトランザクション T1 のコミットをエポック E1 として書き込み
* (4) Limestone が persistent callback を通じて、E1 のローカルコミット成功を Shirakami に通知
* (5) Limestone がレプリカ R1, R2 に対してエポック E1 の内容を転送
* (6) → レプリカ R1 は成功、レプリカ R2 は失敗、レプリカ数の下限を下回ったものとする
* (7) Limestone はレプリカ R2 を切り離し、以降の転送を行わない
* (8) Limestone が persistent callback 通じて、E1 のレプリカコミットの **機能縮退** (replication degradation) を Shirakami に通知
* (9) Shirakami が jogasaki に対し、E1 のレプリカコミットの機能縮退を通知
* (10) Jogasaki がトランザクション T1 の警告付き成功をユーザーに通知

上記に対し、主要な拡張は以下の通り:

* Limestone に以下の拡張を加える
  * persistent callback のイベント種に、 **機能縮退** を追加
* Jogasaki に以下の拡張を加える:
  * 警告付き成功 (例: `COMMITTED_BUT_REPLICATION_DEGRADED`) のメッセージを追加

### (B) トランザクションをロールバック

エラー発生時はおおよそ以下のような流れになる:

* (1) jogasaki がトランザクション T1 のコミットを Shirakami に要求
* (2) Shirakami がトランザクション T1 のコミットを Limestone に要求
* (3) Limestone がトランザクション T1 のコミットをエポック E1 として書き込み
* (4) Limestone が persistent callback を通じて、E1 のローカルコミット成功を Shirakami に通知
* (5) Limestone がレプリカ R1, R2 に対してエポック E1 の内容を転送
* (6) → レプリカ R1 は成功、レプリカ R2 は失敗、レプリカ数の下限を下回ったものとする
* (7) Limestone はレプリカ R2 を切り離し、以降の転送を行わない
* (8) Limestone が persistent callback 通じて、E1 のレプリカコミットの **致命的失敗** (replication failure) を Shirakami に通知
* (9) Limestone が E1 以降のローカルコミットをすべてリワインド (!)
* (10) Limestone がレプリカ R1 に対し、E1 以降のトランザクションのリワインドを依頼
* (11) Limestone はセーフモードへ移行 (セッション閉塞、レプリカが規定数になるまで継続)
* (12) Shirakami がインデックス上の E1 以降のトランザクションをすべてリワインド (!)
* (13) Shirakami はセーフモードへ移行 (トランザクション閉塞、Limestone が利用可能になるまで継続)
* (14) Shirakami が jogasaki に対し、E1 以降のトランザクションの失敗を通知
* (15) Jogasaki がトランザクション T1 のアボートをユーザーに通知

上記に対し、主要な拡張は以下の通り:

* Limestone に以下の拡張を加える
  * ローカルの確定済み・未確定のトランザクションをリワインドする機能
  * レプリカの確定済み・未確定のトランザクションをリワインドする機能
  * レプリカの利用可能性を提供・または通知する機能 (閉塞解除条件)
* Shirakami に以下の拡張を加える
  * 特定のエポックとカスケードするトランザクションをすべてアボートし、
  * かつ Limestone が利用可能になるまでトランザクションを閉塞する機能
  * インデックス上の特定のコミット集合による変更をリワインドする機能

### アクションプラン

* 早急に (A) が対応可能か、各担当が検討
* (B) は実現可能性から検討
  * 特にインデックスのリワインドは性能面に影響が出そう
* おそらく、(A) と (B) を組み合わせて使うことになる
  * 5 replicas で、1-2 失敗時は規定範囲内、 3-4 失敗時に (A) の挙動、5 失敗時に (B) の挙動、など

## レプリケーション系コマンド案

提供すべきコマンド (WIP, TBD):

* 同期系
  * WAL ステータス確認
  * WAL 同期
* モード制御
  * マスターへ昇格
