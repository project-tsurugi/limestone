# 永続化データディレクトリ管理ツール

* 2024-04-10 ban
    * for 1.0.0-BETA4
* 2024-06-22 ban
    * for 1.0.0-BETA5, compaction サブコマンド

## この文書について

永続化データディレクトリ管理ツール tglogutil について説明する.

## 基本的なデザイン・方針

* tsurugi の永続化データディレクトリの管理的操作を行なうツールであり, 単体コマンドとして機能する.
    * tsurugi の設定ファイルを読まず, その情報を利用しない.
* 操作対処ディレクトリを, コマンドパラメータで指定する.
    * tsurugi の構成定義ファイルにおいて `[datastore]` セクションの `log_location` パラメータが指す場所に相当する.

## 対応する破損の種類

* durable でない pWAL エントリの存在 (pWAL ファイルをディスクに書き終えたが, 永続化マーカを書き終えていなかった) (`nondurable`)
    * 1.0.0-BETA2 よりデータベースサービス起動時に自動修復をする対象である
    * 本ツールの自動修復の対象である
* pWAL ファイルの末尾が破損している (pWAL ファイルのディスクへの書き込みが途中までで終わっている (`truncated`), 末尾に 0 が埋まっている (`damaged`))
    * データベースサービス起動時に自動修復をする対象ではない (エラーを出して異常終了する)
    * 本ツールの自動修復の対象である

## 機能一覧 (サブコマンド)

* repair: 永続化データディレクトリの内容を修復する.
* compaction: 永続化データディレクトリの内容を再編し冗長な情報を削除する.

### サブコマンド repair (自動修復)

```
$ tglogutil repair [options] <dblogdir>
```

指定された永続化データディレクトリの内容を自動修復する.
ディレクトリ内部の pWAL ファイルを修復のため書き換える. 
デフォルトでは書き換えは情報を損なわない範囲 (エントリ中のフラグバイトを変更する, ファイル名を変更する, 等) で実施されるが,
オプション指定により, もとのファイルの情報を損なう処理 (ファイルの切りつめ等) を実施する.

修復にあたり変更された内容を表示する.

動作オプション
* `--thread-num=<number>`
    * pWAL ファイル修復の並行処理スレッド数の指定. デフォルト値は 1.
* `--epoch=<epoch>`
    * 採用する epoch の上限を数値で指定する. 指定しない場合のデフォルト動作は永続化マーカが示す数値.
* `--cut=<bool>`
    * 破損タイプ `truncated`, `damaged` の修復時にファイル末尾切り捨てを実施するか. デフォルト動作は切り捨てない (`false`).

リターンコード
* 0: 処理が正常終了
    * もともと正常であったためなにも変更されなかった, あるいは 自動修復が正常終了.
* 16: 処理が異常終了
    * 自動修復できない破損に遭遇した.
* 64以上: 扱えないデータ形式であった.
    * dblogdir が存在しない.
    * dblogdir がアクセス不能.
    * dblogdir ファイル形式異常.
        * 永続化データディレクトリでないディレクトリを指定した
        * 永続化データディレクトリの永続化データフォーマットバージョンがサポートしているバージョンでない
        * epoch ファイルが存在しない

使用上の注意
* データの書き換えを伴うため, ディレクトリのバックアップを取っておくことが望ましい.

### サブコマンド compaction

```
$ tglogutil compaction [options] <dblogdir>
```

詳細は [tglogutil-compaction-man.md](tglogutil-compaction-man.md) を参照のこと

