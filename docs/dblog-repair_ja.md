# 破損した永続化データの修復アルゴリズム

* 2024-03-25 ban
    * for 1.0.0-BETA4

## durable でない pWAL エントリの存在 (pWAL ファイルをディスクに書き終えたが, 永続化マーカを書き終えていなかった)

実装の現状
* 1.0.0-BETA2 よりデータベースサービス起動時の recovery 処理中に自動修復をする対象である

修復処理の概要
* (判定) pWAL ファイル中の破損していない完全な epoch 断片のうち, epoch が 永続化マーカが示すものより大きかった場合
* (処置) epoch 断片ヘッダエントリの entry_type を `marker_begin (0x02)` から `marker_invalidated_begin (0x06)` に書き換える

## pWAL ファイルの末尾が破損している (ファイルが途中で終わっている, あるいは末尾に NUL 文字が埋まっている)

実装の現状
* 1.0.0-BETA4 より tglogutil ツールで自動修復をする対象である

修復処理の概要
* (判定) pWAL ファイルの epoch 断片走査中に, 予期しない (ブロックの途中での) EOF に遭遇した場合
* (判定) pWAL ファイルの epoch 断片走査中に, entry_type 0 のブロックに遭遇した場合
* (処置) epoch 断片ヘッダエントリの entry_type を `marker_begin (0x02)` から `marker_invalidated_begin (0x06)` に書き換える
* (処置) このファイルの末尾に追記されないように, 未ローテートのファイルであった場合には必ずローテートをする (ローテートされているかはファイル名から判断する).
* (補足) 起動時の recovery 処理中には `marker_invalidated_begin (0x06)` の epoch 断片走査中に EOF もしくは entry_type 0 に遭遇した場合には, エラーにせずそれ以降のファイル内容を読み捨てる.
    * `marker_invalidated_begin (0x06)` に遭遇したら即座に読み捨てるわけではないことに注意. epoch 断片として揃っていた場合には, その epoch 断片を読み飛ばすがその後続データは通常のデータとして処理される.
